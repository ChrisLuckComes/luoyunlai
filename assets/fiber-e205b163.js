import{j as e,d as r,e as c}from"./index-57ee3021.js";import{A as h,a as t,b as A,M as a,R as j}from"./index-47083441.js";import{F as u}from"./fiber-78a128cb.js";import{U as s}from"./useMarkdown-858068ef.js";import{A as x}from"./Anchor-bf78e4bb.js";import"./index-1e12511c.js";const b="data:image/png;base64,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",m="/luoyunlai/assets/alternate-a074c166.png",F="/luoyunlai/assets/current-ea6120fe.png",X="/luoyunlai/assets/update-e3c59f52.png",w="/luoyunlai/assets/currentUpdate-f6c48c1a.png";function R(){const i=e.jsx(s,{markdown:h}),d=e.jsx(s,{markdown:t}),n=e.jsx(s,{markdown:A}),o=e.jsx(s,{markdown:a}),l=e.jsx(s,{markdown:j});return e.jsxs("article",{id:"rootArticle",className:r.article,children:[e.jsxs("main",{className:r.content,children:[e.jsx("h2",{id:"idea",className:"font-semibold text-h2 mb-2",children:"概念"}),e.jsx("code",{children:"React"}),"内部实现的一套状态更新机制，支持任务优先级，可中断与恢复，并且恢复后可以复用之前的中间状态。 其中每个任务更新单元为",e.jsx("code",{children:"React Element"}),"对应的",e.jsx("code",{children:"Fiber"}),"节点",e.jsx("h2",{id:"principle",className:r.articleTitle,children:"实现原理"}),e.jsx("h3",{id:"meaning",className:r.articleSubTitle,children:"含义"}),e.jsx("code",{children:"Fiber"}),"包含三层含义",e.jsxs("ul",{children:[e.jsxs("li",{children:["1. React16的",e.jsx("code",{children:"Reconciler"}),"基于",e.jsx("code",{children:"Fiber"}),"节点实现"]}),e.jsxs("li",{children:["2. 作为静态数据结构来说，对应一个",e.jsx("code",{children:"React Element"}),"，保存了组件的类型，dom节点等信息"]}),e.jsxs("li",{children:["3. 作为动态工作单元来说Fiber，每个",e.jsx("code",{children:"Fiber"}),"节点保存了本次更新中组件改变的状态，要执行的工作"]})]}),e.jsx("h3",{id:"structure",className:r.articleSubTitle,children:"结构"}),e.jsx("div",{className:r.assist,children:"packages\\react-reconciler\\src\\ReactFiber.new.js"}),n,"举个栗子，如下组件",d,e.jsx(c,{src:u}),e.jsxs("div",{className:r.assist,children:["那么为什么父级指针叫return不叫parent呢？",e.jsx("code",{children:"return"}),"指的是执行完",e.jsx("code",{children:"completeWork"}),"后返回的下一个节点。虽然返回的确是父级，但是",e.jsx("code",{children:"return"}),"更准确一点"]}),e.jsx("h2",{id:"work",className:r.articleTitle,children:"工作原理"}),e.jsx("h3",{id:"doubleCache",className:r.articleSubTitle,children:"双缓存"}),"双缓存就是",e.jsx("strong",{children:"在内存中构建并直接替换"}),"，这样可以一步到位，避免较大计算量带来的白屏等问题。",e.jsx("code",{children:"React"}),"使用双缓存来完成",e.jsx("code",{children:"Fiber"}),"树的构建与替换",e.jsx("br",{}),e.jsx("h3",{id:"doubleCacheFiber",className:r.articleSubTitle,children:"双缓存Fiber树"}),"在",e.jsx("code",{children:"React"}),"中最多同时存在两棵",e.jsx("code",{children:"Fiber"}),"树。当前屏幕上显示内容对应的Fiber树成为",e.jsx("strong",{children:"current Fiber树"}),"，正在内存中构建的Fiber树称为",e.jsx("strong",{children:"workInProgress Fiber树"}),e.jsx("br",{}),e.jsx("br",{}),"currentFiber和workInProgressFiber通过",e.jsx("code",{children:"alternate"}),"属性连接",i,"当",e.jsx("code",{children:"workInProgress Fiber树"}),"构建完成交给",e.jsx("code",{children:"Renderer"}),"渲染在页面上后，应用根节点的",e.jsx("code",{children:"current"}),"指针指向",e.jsx("code",{children:"workInProgress Fiber树"}),"，此时",e.jsx("code",{children:"workInProgress Fiber树"}),"就变为",e.jsx("code",{children:"current Fiber树"}),e.jsx("br",{}),e.jsx("br",{}),"每次状态更新都会产生新的",e.jsx("code",{children:"workInProgress树"}),"，通过",e.jsx("code",{children:"current"}),"和",e.jsx("code",{children:"workInProgress"}),"的切换，完成dom更新",e.jsx("br",{}),e.jsx("h3",{id:"mount",className:r.articleSubTitle,children:"mount时"}),o,e.jsxs("ul",{children:[e.jsxs("li",{children:["1.首次执行",e.jsx("code",{children:"ReactDOM.render"}),"会创建fiberRootNode和rootFiber,",e.jsx("code",{children:"fiberRootNode"}),"是整个应用的根节点，rootFiber是App所在组件树的根节点。",e.jsx("br",{}),"在应用中我们可以多次render不同的组件树，它们会拥有不同的",e.jsx("code",{children:"rootFiber"}),"，但是整个应用的根节点只有一个，就是",e.jsx("code",{children:"fiberRootNode"}),e.jsx("br",{}),e.jsx("br",{}),e.jsx("code",{children:"fiberRootNode"}),"的",e.jsx("code",{children:"current"}),"会指向当前页面上已渲染内容对应的",e.jsx("code",{children:"Fiber树"}),",即",e.jsx("code",{children:"current Fiber树"}),e.jsx(c,{src:b}),l,"由于是首屏渲染，页面中还没有挂载任何DOM,所以fiberRootNode.current指向的rootFiber没有子fiber节点"]}),e.jsxs("li",{children:["2.接下来进入render阶段，根据组件返回的",e.jsx("code",{children:"JSX"}),"在内存中依次创建Fiber节点并连接在一起构建",e.jsx("code",{children:"Fiber"}),"树，被称为",e.jsx("code",{children:"workInProgress树"}),e.jsx("br",{}),e.jsx("br",{}),"在构建",e.jsx("code",{children:"workInProgress树"}),"时会尝试复用",e.jsx("code",{children:"current树"}),"已有的fiber节点内的属性，在首屏渲染时只有",e.jsx("code",{children:"rootFiber"}),"存在对应的",e.jsx("code",{children:"current fiber"}),"(rootFiber.alternate)",e.jsx("div",{className:r.assist,children:"下图右边为内存中构建的树，左侧为页面显示的树"}),e.jsx(c,{src:m})]}),e.jsxs("li",{children:["3.图中右侧已构建完的",e.jsx("code",{children:"workInProgress树"}),"在",e.jsx("code",{children:"commit阶段"}),"渲染到页面",e.jsx("br",{}),e.jsx("br",{}),"此时DOM更新为右侧树对应的样子。",e.jsx("code",{children:"fiberRootNode"}),"的",e.jsx("code",{children:"current"}),"指针指向",e.jsx("code",{children:"workInProgress树"}),"，使其变为",e.jsx("code",{children:"current树"}),e.jsx(c,{src:F})]})]}),e.jsx("h3",{id:"update",className:r.articleSubTitle,children:"update时"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["1. 点击p节点触发更新，开启新的render阶段并构建新的",e.jsx("code",{children:"workInProgress树"}),e.jsx(c,{src:X}),"和",e.jsx("code",{children:"mount"}),"一样，",e.jsx("code",{children:"workInProgress树"}),"可以复用",e.jsx("code",{children:"current树"}),"对应的节点数据，决定是否复用的过程就是",e.jsx("strong",{children:"diff算法"})]}),e.jsxs("li",{children:["2. ",e.jsx("code",{children:"workInProgress树"}),"在",e.jsx("code",{children:"render阶段"}),"完成构建后进入",e.jsx("code",{children:"commit阶段"}),"渲染到页面上。渲染完成后，",e.jsx("code",{children:"workInProgress树"}),"变为",e.jsx("code",{children:"current树"}),e.jsx(c,{src:w})]})]})]}),e.jsx(x,{items:[{title:"概念",key:"idea",href:"#idea"},{title:"实现原理",key:"principle",href:"#principle",children:[{title:"含义",key:"meaning",href:"#meaning"},{title:"结构",key:"structure",href:"#structure"}]},{title:"工作原理",key:"work",href:"#work",children:[{title:"双缓存",key:"doubleCache",href:"#doubleCache"},{title:"双缓存Fiber树",key:"doubleCacheFiber",href:"#doubleCacheFiber"},{title:"mount时",key:"mount",href:"#mount"},{title:"update时",key:"update",href:"#update"}]}]})]})}export{R as default};
