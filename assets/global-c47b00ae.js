import{j as e,d as s}from"./index-68afbe29.js";import{U as r}from"./useMarkdown-6745780a.js";import{B as f,C as b,c as N,d as C,e as T,f as A,g as R,E as w,h as F,F as _,H as v,N as g,Q as y,i as q,R as J,T as P}from"./index-e286e11f.js";import{A as V}from"./Anchor-7caeca4d.js";import"./index-fc0c5743.js";function B(){const c=e.jsx(r,{markdown:f}),a=e.jsx(r,{markdown:b}),d=e.jsx(r,{markdown:N}),i=e.jsx(r,{markdown:C}),t=e.jsx(r,{markdown:T}),n=e.jsx(r,{markdown:A}),o=e.jsx(r,{markdown:R}),l=e.jsx(r,{markdown:w}),h=e.jsx(r,{markdown:F}),x=e.jsx(r,{markdown:_}),j=e.jsx(r,{markdown:v}),p=e.jsx(r,{markdown:g}),m=e.jsx(r,{markdown:y}),u=e.jsx(r,{markdown:q}),E=e.jsx(r,{markdown:J}),k=e.jsx(r,{markdown:P});return e.jsxs("article",{id:"rootArticle",className:s.article,children:[e.jsxs("main",{className:s.content,children:[e.jsx("h2",{id:"createApp",className:"font-semibold text-h2 mb-2",children:"createApp"}),e.jsx("code",{children:"createApp"}),"是vue3的启动函数，返回一个应用实例，它做了啥？",e.jsx("div",{className:s.assist,children:"packages\\runtime-dom\\src\\index.ts"}),c,"重点在于第一句",e.jsx("code",{children:"ensureRenderer"})," ",h,"调用",e.jsx("code",{children:"createRenderer"}),t,e.jsx("div",{className:s.assist,children:"packages\\runtime-core\\src\\renderer.ts"}),"调用",e.jsx("code",{children:"baseCreateRenderer"}),",",e.jsx("code",{children:"baseCreateRenderer"}),",diff,patch都在这个函数中实现，先看他最后返回值",c,e.jsx("code",{children:"baseCreateRenderer"}),"最终返回",e.jsx("code",{children:"render hydrate createApp"}),"3个函数，然后将",e.jsx("code",{children:"render hydrate"}),"传给",e.jsx("code",{children:"createAppAPI"}),",它是真正的createApp方法",e.jsx("br",{}),e.jsx("br",{}),e.jsx("div",{className:s.assist,children:"packages\\runtime-core\\src\\apiCreateApp.ts"}),"可以看到很多都是眼熟的方法",a,e.jsx("code",{children:"createAppContext"}),"实现",d,"到此整个",e.jsx("code",{children:"createApp"}),"流程就结束了",e.jsx("br",{}),e.jsx("br",{}),e.jsx("h2",{id:"defineComponent",className:s.articleTitle,children:"defineComponent"}),e.jsx("div",{className:s.assist,children:"packages\\runtime-core\\src\\apiDefineComponent.ts"}),"Vue3用它来定义组件，代码返回了传入的对象并人工加上了类型，主要是为了更好的TSX/IDE支持",o,e.jsx("br",{}),e.jsx("br",{}),e.jsx("h2",{id:"h",className:s.articleTitle,children:"h"}),"h代表hyperScript，它在vue的作用是返回一个虚拟节点(VNode)，它接受三个参数",e.jsxs("ul",{className:s.ul,children:[e.jsx("li",{children:"Type 元素类型"}),e.jsx("li",{children:"propsOrChildren 数据对象，这里主要表示props,attrs,class,style"}),e.jsx("li",{children:"Children 子节点"})]}),e.jsx("div",{className:s.assist,children:"packages\\runtime-core\\src\\h.ts"}),j,e.jsx("code",{children:"createVNode"}),"主要做的是props,class,style标准化",e.jsx("div",{className:s.assist,children:"packages\\runtime-core\\src\\vnode.ts"}),n,e.jsx("code",{children:"CreateBaseVNode"}),"创建",e.jsx("code",{children:"VNode"}),",并打上编码标记",i,e.jsx("br",{}),e.jsx("br",{}),e.jsx("h2",{id:"nextTick",className:s.articleTitle,children:"nextTick"}),"在下次DOM更新循环结束后执行延迟回调。修改数据后，使用这个方法可以获取到更新后的值。",e.jsx("h3",{id:"why",className:s.articleSubTitle,children:"为什么需要nextTick"}),"如果没有这个函数，那么每次数据更新都会触发视图更新，所以需要这个机制让数据更新完后只执行一次视图更新",e.jsx("br",{}),e.jsx("br",{}),e.jsx("h3",{id:"how",className:s.articleSubTitle,children:"nextTick实现"}),"它利用了js的EventLoop执行机制，在call stack执行完后检查task queue。Vue3中的实现是直接使用promise新增微任务",e.jsx("div",{className:s.assist,children:"packages\\runtime-core\\src\\scheduler.ts"}),"可以看到代码非常简单，就是新增promise",p,"来看一下vue3是如何处理任务队列的",e.jsx("strong",{children:"queueJob queuePostFlushCb"}),e.jsx("code",{children:"queueJob"}),"维护job队列，每次调用执行",e.jsx("code",{children:"queueFlush"}),e.jsx("code",{children:"queuePostFlushCb "}),"维护cb队列，每次调用执行",e.jsx("code",{children:"queueFlush"}),u,e.jsx("strong",{children:"queueFlush"}),e.jsx("code",{children:"Promise.then"}),"执行",e.jsx("code",{children:"flushJobs"}),"，此处就实现了把flushJobs添加到微任务",m,e.jsx("br",{}),e.jsx("strong",{children:"flushJobs"}),"对队列排序，执行queue中的job，处理完后再调用",e.jsx("code",{children:"postFlushCbs"}),"，如果队列不为空则递归调用",e.jsx("code",{children:"flushJobs"}),x,"这也没看出来哪儿调用了queueJob啊？不着急，接着往下看",e.jsx("div",{className:s.assist,children:"packages\\runtime-core\\src\\renderer.ts"}),"当响应式触发后，执行effect，如果有 ",e.jsx("code",{children:"scheduler"}),"属性，就执行",e.jsx("code",{children:"scheduler"}),"，",e.jsx("code",{children:"ReactiveEffect"}),"第二个参数就是scheduler，可以看到它传的就是",e.jsx("code",{children:"()=>queueJob(update)"}),l,e.jsx("div",{className:s.assist,children:"packages\\runtime-core\\src\\effect.ts"}),E,k]}),e.jsx(V,{items:[{title:"createApp",key:"createApp",href:"#createApp"},{title:"defineComponent",key:"defineComponent",href:"#defineComponent"},{title:"h",key:"h",href:"#h"},{title:"nextTick",key:"nextTick",href:"#nextTick",children:[{title:"为什么需要nextTick",key:"why",href:"#why"},{title:"nextTick实现",key:"how",href:"#how"}]}]})]})}export{B as default};
